<!DOCTYPE html>
<html>
    <head>
        <title>INFO4310 HW3 - rcc263, jmw555</title>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://d3js.org/topojson.v3.min.js"></script>
        <style>
            #main-container{
                display: flex;
                justify-content: center;
                margin-top: 42px;
            }

            svg{
                padding: 0 8px;
                background-color: lightskyblue;
            }

            #filters-container{
                height: 500px;
                width: 300px;
                border: 1px solid lightgrey;
                /* border-top-right-radius: 8px;
                border-bottom-right-radius: 8px; */
                margin-left: 12px;
                padding: 10px;
            }

            #click-info-container{
                height: 500px;
                width: 300px;
                border: 1px solid lightgrey;
                /* border-top-right-radius: 8px;
                border-bottom-right-radius: 8px; */
                /* margin-left: 12px; */
            }

            #click-for-more{
                background-color: white;
                width: 100%;
                height: 100%;
                text-align: center;
                color: grey;
                font-style: italic;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            #click-info{
                padding: 5px;
            }

            .click-content{
                margin-bottom: 8px;
                margin-top: 4px;
            }

            .click-content h4{
                margin-bottom: 3px;
                margin-top: 0;
            }

            .click-content p{
                margin-left: 5px;
                margin-top: 0px;
            }

            .one-line{
                display: flex;
            }

        </style>
    </head>
    <body>
        <div id="main-container">
            <div id="filters-container">
                
            </div>
            <div>
                <svg id="choropleth" width=500 height=500>
                </svg>
            </div>
            <div id="click-info-container">
                <div id="click-info" style="display: none;">
                    <div class="click-content">
                        <h4>Address:</h4>
                        <p id="address"></p>
                    </div>

                    <div class="click-content">
                        <h4>Neighborhood:</h4>
                        <p id="neighborhood"></p>
                    </div>

                    <div class="click-content one-line">
                        <h4>Last sold:</h4>
                        <p id="last-sold"></p>
                    </div>

                    <div class="click-content">
                        <h4>Price Compare:</h4>
                        <p id="priceCompare"></p>
                    </div>

                    <!-- <svg id="graph" height=400 width=700>
                    </svg> -->
                </div>

                <div id="click-for-more">
                    <h2>Click on a home to see more info</h2>
                </div>
            </div>
        </div>

        <script>
            const load = async function() {
                let data = await d3.csv("zillow_pittsburgh.csv");
                // console.log(data);
                let currentData = data;

                const mapsvg = d3.select("#choropleth");
                const mapWidth = mapsvg.attr("width");
                const mapHeight = mapsvg.attr("height");
                const mapMargin = { top: 0, right: 0, bottom: 0, left: 0};
                const mapAreaWidth = mapWidth - mapMargin.left - mapMargin.right;
                const mapAreaHeight = mapHeight - mapMargin.top - mapMargin.bottom;
                const map = mapsvg.append("g")
                                .attr("transform","translate("+mapMargin.left+","+mapMargin.top+")");

                const pittsburgh = await d3.json("pittsburgh.json");

                var nhoods = topojson.feature(pittsburgh, pittsburgh.objects.Neighborhoods_);
                var nhoodsMesh = topojson.mesh(pittsburgh, pittsburgh.objects.Neighborhoods_);
                var projection = d3.geoMercator().fitSize([mapWidth, mapHeight], nhoods);
                var path = d3.geoPath().projection(projection);

                let zoom = d3.zoom()
                    .on('zoom', handleZoom)
                    .scaleExtent([1, 6])
                    .translateExtent([[0, 0], [mapWidth, mapHeight]]);

                function handleZoom(e) {
                    d3.select('svg g')
                        .attr('transform', e.transform);
                }

                function initZoom() {
                    d3.select('svg')
                        .call(zoom);
                }

                map.selectAll("path.nhood").data(nhoods.features)
                    .join("path")
                    .attr("class", "nhood")
                    .attr("fill", "beige")
                    .attr("d", path);
                map.append("path").datum(nhoodsMesh)
                    .attr("class","outline")
                    .attr("fill", "none")
                    .attr("stroke", "grey")
                    .attr("d", path);

                data.forEach(d => {
                    d['coords'] = projection([ d['Longitude'], d['Latitude'] ]);
                });

                function plotCircles(filteredData){
                    // console.log(filteredData)

                    let circles = map.selectAll("circle")
                        .data(filteredData).join('circle')
                        // .append("circle")
                        .attr("cx", function (d) { return d['coords'][0]; })
                        .attr("cy", function (d) { return d['coords'][1]; })
                        .attr("r", 3)
                        .attr("fill", "navy")
                        .attr("opacity", .5)
                        .attr("class", "home")
                        .style("cursor", "pointer")
                        .on("mouseover", function(e, d){
                            d3.select(this)
                                .raise()
                                .transition().duration(250)
                                .attr("r", 8)
                                .attr("opacity", 0.8)

                        })

                        .on("click", function(e,d){
                            d3.select("#click-info").style("display", "block")
                            d3.select("#click-for-more").style("display", "none")

                            console.log(d)
                            
                            d3.select("#address").text(d['Street Address'])
                            d3.select("#neighborhood").text(d['Neighborhood'])
                            if (d['Last Sold Price'] != ""){
                                d3.select("#last-sold").text("$" + Number(d['Last Sold Price']).toLocaleString() + " on " + d['Last Sold Date'])
                            } else {
                                d3.select("#last-sold").text("N/A")
                            }

                            

                            // const bar = d3.select("svg#graph");
                            // const width = bar.attr("width");
                            // const height = bar.attr("height");
                            // const margin = {top: 15, right: 15, bottom: 150, left: 50};
                            // const chartWidth = width - margin.left - margin.right;
                            // const chartHeight = height - margin.top - margin.bottom;

                            let similarData = data.filter((x) => { return (x['Bedrooms'] === d['Bedrooms'] && x['Bathroom'] === d['Bathroom'])})
                            // let bins = {};
                            // for (let i=0;i<=2000000;i=i+200000) {
                            //     bins[i] = 0;
                            // }
                            // similarData.forEach(d => {
                            //     Object.keys(bins).forEach(b => {
                            //         if (b > d['Sale Amount']) {
                            //             bins[b-10000]++
                            //         }
                            //     });
                            // });
                            // let countData = [];
                            // Object.keys(bins).forEach(b => {
                            //     if (!bins[b]) {
                            //         bins[b] = 0;
                            //     }
                            //     countData.push({"price": b, "count": bins[b]});
                            // });

                            // const countExtent = d3.extent(countData, d => d['count']);
                            // console.log(countExtent)
                            // const countScale = d3.scaleLinear().domain(countExtent).range([chartHeight, 0]);
                            // const binScale = d3.scaleBand().domain(Object.keys(bins)).range([0, chartWidth])
                            
                            // let leftAxis = d3.axisLeft(countScale);
                            // bar.append("g")
                            //         .attr("class", "y axis")
                            //         .attr("transform",`translate(${margin.left},${margin.top})`)
                            //         .call(leftAxis);
                            // let bottomAxis = d3.axisBottom(binScale);
                            // bar.append("g")
                            //     .attr("class", "x axis")
                            //     .attr("transform", `translate(${margin.left},${chartHeight + margin.top})`)
                            //     .call(bottomAxis)
                            //     .selectAll("text")
                            //     .attr("y", 0)
                            //     .attr("x", 9)
                            //     .attr("dy", ".35em")
                            //     .attr("transform", "rotate(60)")
                            //     .style("text-anchor", "start");

                            // bar.selectAll('rect.bar').data(countData)
                            //     .join('rect').attr("class", "bar")
                            //     .attr("id", d => d["price"])
                            //     .attr("fill", "lightblue")
                            //     .attr("x", d => binScale(d["price"]))
                            //     .attr("y", d => countScale(d["count"]))
                            //     .attr("height", d => (countScale(1) - countScale(d["count"])))
                            //     .attr("width", 5)
                            //     .attr("opacity", 0.7)
                            //     .attr("transform","translate("+margin.left+","+margin.top+")")

                            let avgPrice = d3.mean(similarData, d => parseInt(d['Sale Amount']));
                            avgPrice = Math.round(avgPrice)
                            d3.select("#priceCompare").text("Sale Amount: " + d['Sale Amount'] + " Avg. Price: " + avgPrice)  
                        })

                        .on("mouseout", function(e,d){
                            d3.select(this)
                                .transition().duration(250)
                                .attr("r", 3)
                                .attr("opacity", .5)
                        })
            }

                initZoom();

                let currentFilters = {};
                function filter(field, value){
                    delete currentFilters[field]
                    currentData = data
                    Object.keys(currentFilters).forEach(key => {
                        console.log(key);
                        if (key === "Sale Amount") {
                            if (currentFilters[key] === "All") {
                                currentData = currentData.filter((d) => { return (parseInt(d[key]) >= 0 && parseInt(d[key]) <= 2000000)});
                            } else {
                                let prices = currentFilters[key].split("-");
                                prices[0] = parseInt(prices[0].replace(/,/g, ''));
                                prices[1] = parseInt(prices[1].replace(/,/g, ''));
                                currentData = currentData.filter((d) => { return (parseInt(d[key]) >= prices[0] && parseInt(d[key]) <= prices[1])});
                            }
                        } else {
                            currentData = currentData.filter((d) => { return (d[key] === currentFilters[key])})
                        }
                    })
                    if (value!=="Any" && value!=="All") {
                        if (field === "Sale Amount") {
                                let prices = value.split("-");
                                prices[0] = parseInt(prices[0].replace(/,/g, ''));
                                prices[1] = parseInt(prices[1].replace(/,/g, ''));
                                currentData = currentData.filter((d) => { return (parseInt(d[field]) >= prices[0] && parseInt(d[field]) <= prices[1])});
                                currentFilters[field] = value;
                        } else {
                            currentData = currentData.filter((d) => { return (d[field] == value)})
                            currentFilters[field] = value;
                        }
                    }

                    plotCircles(currentData)
                }

                function handleZoom(e) {
                    d3.select('svg g')
                        .attr('transform', e.transform);
                }

                function createDropdown(field) {
                    let values = [];
                    
                    data.forEach(d => {
                        if (!values.includes(d[field]) && d[field] !== "") {
                            values.push(d[field]);
                        }
                    })
                    values.sort();
                    values.unshift("Any");
                    var label = d3.select("div#filters-container").append("text").text(field);
                    var select = d3.select("div#filters-container")
                                        .append("div")
                                        .append("select")
                                        .attr("class", "dropdownFilter")
                                        .attr("id", `${field}Select`)
                                        .attr("data-field", field)
                                        .style("border", "1px solid black")
                                        .style("border-radius", "5px")
                                        // .style("width", "35%")
                                        .style("margin-top", "6px")
                                        .style("margin-bottom", "12px")
                                        .on("change", function(e, d){
                                            filter(d3.select(this).attr("data-field"), d3.select(this).node().value);
                                        })

                    select.selectAll(`${field}Select`)
                            .data(values)
                            .enter()
                                .append("option")
                                .attr("value", function (d) { return d; })
                                .text(function (d) { return d; });
                }

                var priceDiv = d3.select("div#filters-container")
                                .append("div")
                                .attr("id", "priceDiv")
                                .style("display", "flex")
                                .style("flex-direction", "column")
                                .style("justify-content", "space-between")
                var priceLabel = d3.select("div#priceDiv").append("text").text("Price Range");
                let priceRanges = {"all": "All", "first": "0-100,000", "second": "100,001-200,000", "third": "200,001-300,000", "fourth": "300,001-400,000", "fifth": "500,001-1,000,000"}
                Object.keys(priceRanges).forEach(p => {
                    var priceSelect = d3.select("div#priceDiv")
                                        .append("div")
                                        .attr("id", `${p}Div`)
                                        .append("input")
                                        .attr("type", "radio")
                                        .style("visibility", "hidden")
                                        .style("margin", "10px")
                                        .attr("name", "priceRange")
                                        .attr("id", p)
                                        .attr("value", priceRanges[p])
                                        .attr("data-field", "Sale Amount")
                    var label = d3.select(`div#${p}Div`)
                                    .append("label")
                                    .attr("for", p)
                                    .text(priceRanges[p])
                                    .style("cursor", "pointer")
                                    .style("background", "lightgray")
                                    .style("border", "1px solid black")
                                    .style("border-radius", "5px")
                                    .style("display", "inline-block")
                                    .style("width", "150px")
                                    .style("text-align", "center")
                                    
                });
                d3.selectAll("input[name='priceRange']").on("change", function(){
                    filter(d3.select(this).attr("data-field"), d3.select(this).node().value);
                });

                const priceExtent = d3.extent(data, d => parseInt(d['Sale Amount']));
                console.log(priceExtent);

                // <span class="rangeValues"></span>
                // <input value="500" min="500" max="50000" step="500" type="range">
                // <input value="50000" min="500" max="50000" step="500" type="range">


                createDropdown('Neighborhood');
                createDropdown('Bedrooms');
                createDropdown('Bathroom');
                createDropdown('Property Type');
                plotCircles(data);

            }
            load();


        </script>
    </body>
</html>